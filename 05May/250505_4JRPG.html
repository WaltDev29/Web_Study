<!DOCTYPE html>
<html lang="en">

<head>
    <!--애니메이션 추가 (공격, 피격, 사망, 메시지 박스, status창)        
        타이틀 화면 애니메이션 추가
        -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legend Of Poly</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="250505_4JRPG.css" rel="stylesheet">
</head>

<body>
    <header>
        <h1>JRPG</h1>
    </header>
    <main>
        <audio src="audio/bgm.mp3" autoplay loop></audio>
        <div id="titleScreen">
            <img id="titleImg" src="img/title.png"></img>
        </div>
        <div id="gameContainer" class="pixel-font">            
            <div id="playScreen">
                <div id="monsterStatus">
                    <div class="status_name">Slime</div>
                    <div class="status_level">Lv 1</div>
                    <div class="status_hp">HP 100/100</div>
                </div>
                <div id="playerStatus">
                    <div class="status_name">Wizard</div>
                    <div class="status_level">Lv 1</div>
                    <div class="status_hp">HP 100/100</div>
                    <div class="status_mp">MP 100/100</div>
                </div>
                <img id="monster_img" src="img/slime_front.png">
                <img id="player_img" src="img/wizard_back.png">
            </div>
            <div id="controlBox">
                <div id="behavior_container">
                    <div id="behavior_pAtk" class="chooseBox">Attack</div>
                    <div id="behavior_mAtk" class="chooseBox">Skill</div>
                    <div id="behavior_item" class="chooseBox">Item</div>
                    <div id="behavior_flee" class="chooseBox">Flee</div>
                </div>
                <div id="pAtk_container">
                </div>
                <div id="mAtk_container">
                </div>
                <div id="message_container">
                </div>
            </div>
        </div>
    </main>
    <!-- 클래스 정의 -->
    <script src="250505_4JRPG.js"></script>
    <!-- UI -->
    <script>
        // 타이틀 화면 변수 선언
        let titleScreen = document.querySelector("#titleScreen");
        let gameContainer = document.querySelector("#gameContainer");
        // 선택창 변수 선언
        let behavior_container = document.querySelector("#behavior_container");
        let behavior_pAtk = document.querySelector("#behavior_pAtk");
        let behavior_mAtk = document.querySelector("#behavior_mAtk");
        let behavior_item = document.querySelector("#behavior_item");
        let behavior_flee = document.querySelector("#behavior_flee");
        // 메시지 박스 변수 선언
        let message_container = document.querySelector("#message_container");
        // 상태창 변수 선언
        let player_status_name = document.querySelector("#playerStatus .status_name");
        let player_status_level = document.querySelector("#playerStatus .status_level");
        let player_status_hp = document.querySelector("#playerStatus .status_hp");
        let player_status_mp = document.querySelector("#playerStatus .status_mp");
        let monster_status_name = document.querySelector("#monsterStatus .status_name");
        let monster_status_hp = document.querySelector("#monsterStatus .status_hp");
        let monster_status_level = document.querySelector("#monsterStatus .status_level");

        // 객체 생성
        let player = new Wizard("종민", 80, 100);
        player.setStat(5, 5, 5, 5);
        let monster = new Slime("슬라임", 1, 50, 50, 3, 3, 3, 3);
        // 상태창 초기화
        player_status_name.textContent = player.name;
        player_status_level.textContent = "Lv " + player.level;
        player_status_hp.textContent = "HP " + player.hp + "/" + player.maxHp;
        player_status_mp.textContent = "MP " + player.mp + "/" + player.maxMp;
        monster_status_name.textContent = monster.name;
        monster_status_hp.textContent = "HP " + monster.hp + "/" + monster.maxHp;
        monster_status_level.textContent = "Lv " + monster.level;

        let damage;
        let dodge;
        let flee = false;
        let playerTurn = true;

        // 타이틀 화면 클릭 이벤트 메서드
        titleScreen.addEventListener("click", function() {
            titleScreen.style.display = "none";
            gameContainer.style.display = "grid";
        })
        // 선택창 클릭 이벤트 메서드
        // 물리 공격
        behavior_pAtk.addEventListener("click", function () {
            damage = player.pAtk();
            addMessage(`${player.name}의 공격!`);
            dodge = monster.dodge();
            if (dodge == false) {
                addMessage(`${monster.name}은 ${damage}의 데미지를 입었다!`);
                monster.takeDamage(damage);
                monster_status_hp.textContent = "HP " + monster.hp + "/" + monster.maxHp;
            } else {
                addMessage(`${player.name}의 공격은 빗나갔다!`);
                damage = 0;
            }
            if (monster.hp <= 0) {
                monster.life = false;
                addMessage(monster.name + "은 쓰러졌다!");
            }
            playerTurn = false;
            behavior_container.style.display = "none";
            message_container.style.display = "block";
        });
        // 마법 공격
        behavior_mAtk.addEventListener("click", function () {
            if (player.mp < 10) {
                addMessage("MP가 부족하다!");
                behavior_container.style.display = "none";
                message_container.style.display = "block";
                return;
            }
            damage = player.mAtk();
            addMessage(`${player.name}의 마법공격!`);
            dodge = monster.dodge();
            if (dodge == false) {
                addMessage(`${monster.name}은 ${damage}의 데미지를 입었다!`);
                monster.takeDamage(damage);
                player_status_mp.textContent = "MP " + player.mp + "/" + player.maxMp;
                monster_status_hp.textContent = "HP " + monster.hp + "/" + monster.maxHp;
            } else {
                addMessage(`${player.name}의 공격은 빗나갔다!`);
                player_status_mp.textContent = "MP " + player.mp + "/" + player.maxMp;
                damage = 0;
            }
            if (monster.hp <= 0) {
                monster.life = false;
                addMessage(monster.name + "은 쓰러졌다!");
            }
            playerTurn = false;
            behavior_container.style.display = "none";
            message_container.style.display = "block";
        });
        // Flee
        behavior_flee.addEventListener("click", function () {
            if (player.flee(monster.level)) {
                flee = true;
                addMessage(`${player.name}은 도망쳤다!`);
            }
            else {                
                addMessage("도망칠 수 없었다!");
            }
            playerTurn = false;
            behavior_container.style.display = "none";
            message_container.style.display = "block";
        })
        // 몬스터 공격
        function monsterTurn() {
            damage = monster.pAtk();
            addMessage(`${monster.name}의 공격!`);
            dodge = player.dodge();
            if (dodge == false) {
                addMessage(`${player.name}은 ${damage}의 데미지를 입었다!`);
                player.takeDamage(damage);
                player_status_hp.textContent = "HP " + player.hp + "/" + player.maxHp;
            } else {
                addMessage(`${monster.name}의 공격은 빗나갔다!`);
                damage = 0;
            }
            if (player.hp <= 0) {
                player.life = false;
                addMessage(player.name + "은 쓰러졌다!");
            }
            behavior_container.style.display = "none";
            message_container.style.display = "block";
            playerTurn = true;
        }
        // 메시지 생성
        function addMessage(str) {
            let newP = document.createElement('p');
            newP.textContent = str;
            message_container.appendChild(newP);
        }
        // 메시지 박스 클릭 이벤트 메서드
        message_container.addEventListener("click", handleMessage);
        // 메시지 핸들링 메서드
        function handleMessage() {            
            if (flee) {
                message_container.innerHTML = "<p>쫄보<p>";
                return;
            }
            message_container.innerHTML = "";
            if (!monster.life) {
                message_container.innerHTML = "<p>게임클리어!</p>";
                return;
            }
            if (!player.life) {
                message_container.innerHTML = "<p>You Died</p>";
                return;
            }
            if (!playerTurn) {
                monsterTurn();
                return;
            }            
            message_container.style.display = "none";
            behavior_container.style.display = "grid";
        }
    </script>
</body>

</html>